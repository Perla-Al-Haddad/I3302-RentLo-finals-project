@using Microsoft.AspNetCore.Identity
@model I3302_RentLo_finals_project.Models.UserPropertyRent
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="row d-flex justify-content-center">
    <div class="col-md-10">
        <div class="card card-rounded grid-margin">
            <div class="card-body">
                <h2 class="pb-2" style="border-bottom: 1px solid #ddd;">Rent Property</h2>
                <form asp-action="Create">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <div class="form-group">
                        <input asp-for="RenterId" value="@UserManager.GetUserAsync(User).Result.Id" type="hidden" class="form-control" />
                    </div>
                    <div class="form-group">
                        <input asp-for="PropertyId" value="@ViewBag.PropertyId" class="form-control" type="hidden" />
                    </div>
                    <div class="row pb-3">
                        <div id="datepicker-container" style="border-bottom: 1px solid #ddd;" class="form-group">
                            <div class="input-daterange flex-column" id="datepicker">
                                <div class="row">
                                    <div class="col-8">
                                        <div class="form-group">
                                            <label asp-for="StartDate" class="control-label mt-2"></label>
                                            <div class="input-group date d-flex align-items-center border border-secondary border-3 rounded-3">
                                                <input autocomplete="off" asp-for="StartDate" id="check-in-date" type="text" class="form-control" />
                                                <span class="input-group-addon px-3">
                                                    <i class="text-primary fa-solid fa-calendar-days fa-xl"></i>
                                                </span>
                                            </div>
                                            <span asp-validation-for="StartDate" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <label class="control-label mt-2">Total Cost</label>
                                        <h3 id="total-cost" class="mt-2 text-secondary">
                                            <small style="font-size: 1rem">Please Select your check-out dates</small>
                                        </h3>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-8">
                                        <div class="form-group pb-4">
                                            <label asp-for="EndDate" class="control-label mt-2"></label>
                                            <div class="input-group date d-flex align-items-center border border-secondary border-3 rounded-3">
                                                <input autocomplete="off" asp-for="EndDate" id="check-out-date" type="text" class="form-control" />
                                                <span class="input-group-addon px-3">
                                                    <i class="text-primary fa-solid fa-calendar-days fa-xl"></i>
                                                </span>
                                            </div>
                                            <span asp-validation-for="EndDate" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div>
                                            <label class="control-label mt-2">Total Number Of Days</label>
                                            <h3 id="total-number-of-days" class="mt-2 text-secondary">
                                                <small style="font-size: 1rem">Please Select your check-out dates</small>
                                            </h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-6">
                            <a class="btn btn-secondary w-100" asp-controller="Properties" asp-action="Index">Cancel</a>
                        </div>
                        <div class="col-6">
                            <input type="submit" value="Next" class="btn btn-primary w-100" />
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


@section Scripts {
<script>
    function getDatesInRange(startDate, endDate) {
        const date = new Date(startDate);
        endDate = new Date(endDate);
        endDate.setDate(endDate.getDate() + 1);

        const dates = [];

        while (date <= endDate) {
            dates.push(new Date(date));
            date.setDate(date.getDate() + 1);
        }

      return dates;
    }

    function dateDisabled(date, disabledDates) {
        for (let i = 0; i < disabledDates.length; i++) 
            if (disabledDates[i].toDateString() == date.toDateString()) 
                return true;
        return false;
    }

    $(document).ready(() => {
        $.ajax({
            type: "GET",
            url: '/UserPropertyRents/OnGetRentedRangesByPropertyId?propertyId=' + @ViewBag.PropertyId,
            success: function (data) {
                let disabledDates = [];

                for (let i = 0; i < data.length; i++) {
                    disabledDates.push(...getDatesInRange(data[i][0], data[i][1]));
                }
                console.log(disabledDates);

                $("#check-in-date").datepicker({
                    autoclose: true,
                    format: "yyyy-mm-ddT00:00",
                    startDate: "today",
                    datesDisabled: disabledDates
                }).on('changeDate', function (selected) {
                        var minDate = new Date(selected.date.valueOf());
                        minDate.setDate(minDate.getDate() + 1);
                        $('#check-out-date').datepicker('setStartDate', minDate);
                    });

                var today = new Date();
                var cur_date = today;
                if (dateDisabled(today, disabledDates)) {
                    while (dateDisabled(cur_date, disabledDates)) {
                        cur_date.setDate(cur_date.getDate() + 1);
                    }
                    cur_date.setDate(cur_date.getDate() - 1);
                    $('#check-in-date').datepicker('update', cur_date);
                } else {
                    $('#check-in-date').datepicker('update', new Date());
                }
                
                var tomorrow = new Date();
                cur_date.setDate(cur_date.getDate() + 1);
                tomorrow.setDate(tomorrow.getDate() + 1);
                disabledDates.push(cur_date)
                console.log(disabledDates)
                $("#check-out-date").datepicker({
                    format: "yyyy-mm-ddT00:00",
                    startDate: tomorrow,
                    datesDisabled: disabledDates
                }).on('changeDate', function (selected) {
                        var minDate = new Date(selected.date.valueOf());
                        $('#check-in-date').datepicker('setEndDate', minDate);
                    });

                $("#datepicker-container input").on('change', function() {
                    let checkInDate = new Date($('#check-in-date').val());
                    let checkOutDate = new Date($('#check-out-date').val());
                    let difference = checkOutDate - checkInDate;
                    let totalDays = Math.ceil(difference / (1000 * 3600 * 24));
                    let price = @ViewBag.Property_PricePerDay * totalDays;
                    if (totalDays) {
                        $('#total-number-of-days').html(totalDays);
                    } else {
                        $('#total-number-of-days').html('<small style="font-size: 1rem">Please Select your check-out and check-in dates</small>');
                    }
                    if (price) {
                        $('#total-cost').html(`<i class="fa-solid fa-dollar-sign"></i> ` + price.toFixed(2));
                    } else {
                        $('#total-cost').html('<small style="font-size: 1rem">Please Select your check-out and check-in dates</small>');
                    }
                });
            },
            error: function (result) {
                alert("fail");
            }
        });
        /*$('#datepicker-container input').datepicker({
                datesDisabled: ['07/06/2022', '07/21/2022'],
                format: "yyyy-mm-ddT00:00",
                startDate: "today"
            });*/
    });
</script>

@{
    await Html.RenderPartialAsync("_ValidationScriptsPartial");
}
}
